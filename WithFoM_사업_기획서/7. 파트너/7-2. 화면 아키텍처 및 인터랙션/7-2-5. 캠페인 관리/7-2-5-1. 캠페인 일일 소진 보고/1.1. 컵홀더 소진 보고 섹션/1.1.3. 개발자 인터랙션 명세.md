<!-- WF:DOC=DEV -->
**1.1.3.** 개발자 인터랙션 명세  


**1.1.3.1.** 소진 보고 API  

1: 엔드포인트  
　A. POST /api/v1/partner/campaign/report-consumption  
　B. 인증: Bearer Token (파트너 세션)  

2: 요청 파라미터  

```json
{
  "consumptionDate": "2026-02-11",
  "quantity": 45
}
```

3: 응답 구조  

```json
{
  "status": "success",
  "updatedReport": {
    "reportId": "RPT-2026-0211-001",
    "consumptionDate": "2026-02-11",
    "quantity": 45,
    "reportedAt": "2026-02-11T21:30:00+09:00",
    "reportStatus": "completed"
  }
}
```


**1.1.3.2.** 소진 보고 수정 API  

1: 엔드포인트  
　A. PUT /api/v1/partner/campaign/report-consumption/{reportId}  
　B. 인증: Bearer Token (파트너 세션)  

2: 요청 파라미터  

```json
{
  "quantity": 50,
  "reason": "입력 오류 수정"
}
```

3: 수정 가능 시간 검증 로직  

```javascript
const canEditReport = (storeOpenTime, reportDate) => {
  const editDeadline = new Date(reportDate);
  editDeadline.setDate(editDeadline.getDate() + 1);
  editDeadline.setHours(storeOpenTime.getHours() + 2);
  // 24시간 매장 예외: 다음 날 오전 11:00까지
  if (storeOpenTime === '00:00') {
    editDeadline.setHours(11, 0, 0, 0);
  }
  return new Date() <= editDeadline;
};
```

4: 응답 구조  

```json
{
  "status": "success",
  "updatedReport": {
    "reportId": "RPT-2026-0211-001",
    "quantity": 50,
    "previousQuantity": 45,
    "modifiedAt": "2026-02-12T09:15:00+09:00",
    "modificationHistory": [
      { "before": 45, "after": 50, "modifiedAt": "2026-02-12T09:15:00+09:00" }
    ]
  }
}
```


**1.1.3.3.** 소진 보고 현황 조회 API  

1: 엔드포인트  
　A. GET /api/v1/partner/campaign/report-status  
　B. 인증: Bearer Token (파트너 세션)  

2: 요청 파라미터  
　A. partnerId: 파트너 ID (JWT에서 자동 추출)  

3: 응답 구조  

```json
{
  "todayReport": {
    "reportStatus": "completed",
    "quantity": 45,
    "reportedAt": "2026-02-11T21:30:00+09:00"
  },
  "yesterdayReport": {
    "reportStatus": "completed",
    "quantity": 42,
    "canEdit": true,
    "editDeadline": "2026-02-12T11:00:00+09:00"
  },
  "reportStatus": {
    "statusText": "오늘 보고 완료",
    "statusColor": "green"
  }
}
```


**1.1.3.4.** 컴포넌트 상태 관리  

1: reportState  
　A. 보고 상태: reportStatus ('completed' | 'pending' | 'missing')  
　B. 상태 텍스트: statusText (string) — "오늘 보고 완료" / "오늘 보고 미완료"  
　C. 상태 색상: statusColor ('green' | 'red')  
　D. 전일 소진량: yesterdayQuantity (number | null)  
　E. 전일 수정 가능 여부: canEditYesterday (boolean)  
　F. 전일 수정 마감: editDeadline (datetime)  

2: inputState  
　A. 입력값: quantity (number)  
　B. 제출 상태: isSubmitting (boolean)  
　C. 제출 완료: isSubmitted (boolean)  

4: editState  
　A. 수정 모드: isEditMode (boolean)  
　B. 수정 가능 여부: canEdit (boolean)  
　C. 수정 마감 시간: editDeadline (datetime)  

5: alertState  
　A. 경고 팝업 표시: showWarning (boolean)  
　B. 경고 메시지: warningMessage (string)  
　C. 팝업 액션: onConfirm, onCancel (function)  


**1.1.3.5.** 소진량 경고 팝업 검증 로직  

↳ 제출 시 입력값이 평균 대비 비정상적인 경우 사용자에게 재확인 팝업 표시  

1: 검증 로직

```javascript
const checkConsumptionWarning = (todayQty, recentReports) => {
  // 최근 7일간 보고 평균 계산 (보고 완료된 날짜만)
  const completedReports = recentReports.filter(r => r.reportStatus === 'completed');
  if (completedReports.length === 0) return { showWarning: false };

  const avg = completedReports.reduce((sum, r) => sum + r.quantity, 0) / completedReports.length;
  const ratio = Math.abs(todayQty - avg) / avg;

  // 평균 대비 1.5배(150%) 이상 차이 시 경고 팝업 표시
  if (ratio >= 1.5) {
    return {
      showWarning: true,
      message: '입력값이 평균값을 벗어났습니다.\n맞는지 확인해 주세요.',
      inputValue: todayQty,
      averageValue: Math.round(avg)
    };
  }
  return { showWarning: false };
};
```

2: 팝업 분기  
　A. 취소: 입력창으로 돌아가 수정 가능  
　B. 확인: 입력값 그대로 제출 처리 (경고 무시)  


**1.1.3.6.** 이상 탐지 로직 (FDS)  

↳ 아래 계산 방식은 시스템 내부 처리이며 화면에 표시되지 않음  

1: 내부 계산  

```javascript
const detectAnomaly = (todayQty, yesterdayQty) => {
  // 전일 대비 ±150% 급변 감지
  const changeRate = Math.abs(todayQty - yesterdayQty) / yesterdayQty;
  const isRapidChange = changeRate >= 1.5;

  return {
    isAnomaly: isRapidChange,
    reason: isRapidChange ? 'rapid_change' : null
  };
};
```


**1.1.3.7.** 접근성 요구사항  

1: 입력창 ARIA  
　A. aria-label="오늘 소진량 입력"  
　B. inputmode="numeric"  
　C. pattern="[0-9]*"  

2: 제출 버튼  
　A. aria-label="소진 보고 제출"  
　B. keyboard navigation: Enter 키로 제출  
　C. Tab 키로 입력창 → 제출 버튼 이동  

3: 상태 카드 ARIA  
　A. role="status"  
　B. aria-label="오늘 보고 상태: {완료/미완료}"  


**1.1.3.8.** 에러 처리  

1: 에러 코드  
　A. RPT_001: 보고 제출 실패  
　B. RPT_002: 수정 시간 초과  
　C. RPT_003: 현황 조회 실패  

2: 사용자 메시지  
　A. RPT_001: "소진 보고 제출에 실패했습니다. 다시 시도해 주세요."  
　B. RPT_002: "수정 가능 시간이 지났습니다."  
　C. RPT_003: "보고 현황을 불러오지 못했습니다."  
　D. 모든 에러에 재시도 버튼 표시  


**1.1.3.9.** 미보고 알림 스케줄링  

1: 알림 스케줄러

```javascript
// 영업 종료 후 미보고 알림 스케줄링
const scheduleUnreportedAlerts = async (partnerId, storeCloseTime) => {
  const todayReport = await getReportStatus(partnerId, today());
  if (todayReport.reportStatus === 'completed') return;

  // 1차 알림: 영업 종료 후 1시간 경과
  const firstAlertTime = new Date(storeCloseTime);
  firstAlertTime.setHours(firstAlertTime.getHours() + 1);

  scheduleNotification({
    partnerId,
    type: 'UNREPORTED_FIRST',
    scheduledAt: firstAlertTime,
    channels: ['PUSH', 'IN_APP'],
    message: '어제 소진 보고가 완료되지 않았습니다. 소진 보고를 완료해 주세요.',
    actionUrl: '/campaign/daily-report' // 소진 보고 바로가기
  });

  // 2차 알림: 익일 오전 10시 미보고 시
  const secondAlertTime = new Date(today());
  secondAlertTime.setDate(secondAlertTime.getDate() + 1);
  secondAlertTime.setHours(10, 0, 0, 0);

  scheduleNotification({
    partnerId,
    type: 'UNREPORTED_SECOND',
    scheduledAt: secondAlertTime,
    condition: () => getReportStatus(partnerId, today()).reportStatus !== 'completed',
    channels: ['PUSH', 'IN_APP'],
    message: '어제 소진 보고가 완료되지 않았습니다. 소진 보고를 완료해 주세요.'
  });
};

// 연속 미보고 경고 (매일 실행 배치)
const checkConsecutiveUnreported = async () => {
  const partners = await getActivePartners();
  for (const partner of partners) {
    const recentDays = await getRecentReportStatus(partner.id, 3); // 최근 3일
    const consecutiveMissing = recentDays.filter(d => d.reportStatus === 'missing').length;

    if (consecutiveMissing >= 3) {
      await sendNotification(partner.id, {
        type: 'UNREPORTED_WARNING',
        channels: ['PUSH', 'IN_APP'],
        message: '소진 보고가 연속으로 누락되고 있습니다. 정확한 정산을 위해 소진 보고를 꼭 완료해 주세요.'
      });
    }
  }
};
```

2: 알림 단계  
　A. 1차: 영업 종료 후 1시간 경과  
　B. 2차: 익일 오전 10시 미보고 시  
　C. 경고: 연속 3일 미보고 시  


**1.1.3.10.** 성능 최적화  

1: 입력 debounce  
　A. 입력값 검증은 300ms debounce 적용  
　B. 제출 버튼 중복 클릭 방지 (isSubmitting 상태 체크)  

2: 세션 스토리지 캐싱  
　A. 보고 현황 데이터 세션 스토리지에 15분 캐싱  
　B. 소진 보고 제출 시 캐시 무효화  
　C. 페이지 진입 시 캐시 유효성 확인 후 API 호출  


• 참조: 7-1-5-3. 영업 종료 시점 일일 소진량 입력, 7-1-5-4. 미보고 알림 수신
