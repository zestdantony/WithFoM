<!-- WF:DOC=DEV -->
**2.1.3.** 개발자 인터랙션 명세  


**2.1.3.1.** 캠페인 매칭 정보 조회 API  

1: 엔드포인트  
　A. `GET /api/v1/partner/campaign/matching`  
　B. 인증: Bearer Token (파트너 세션)  

2: 응답 JSON

```json
{
  "matching": {
    "campaignId": "CMP-2026-0042",
    "round": 3,
    "status": "MATCHED",
    "cupholderCount": 500,
    "cupholderType": "STANDARD",
    "campaignPeriod": {
      "startDate": "2026-03-01",
      "endDate": "2026-03-31"
    },
    "responseDeadline": "2026-02-13T15:00:00+09:00",
    "partnerGrade": "SILVER",
    "gradeDiscount": "FREE",
    "abandonCount": 1,
    "abandonLimit": 3,
    "matchingPenalty": -0.5,
    "isSuspended": false,
    "suspendedUntil": null
  }
}
```

3: 응답 필드
　A. `status`: MATCHED(매칭됨), WAITING(대기 중), CONFIRMED(확정됨), ABANDONED(포기됨), WITHDRAW_REQUESTED(중도 포기 요청중), WITHDRAWN(중도 포기 확정)
　B. `responseDeadline`: 응답 기한(매칭 알림 수신 후 익일 15시)
　C. `partnerGrade`: 현재 파트너 등급
　D. `abandonCount`: 총 누적 포기 횟수
　E. `abandonLimit`: 포기 허용 한도 (기본 3회)
　F. `matchingPenalty`: 포기 누적 감점 (매칭 전/자동 포기: -0.5, 참여 중 포기: -1.0, 관리자 복원 시 해당 감점만큼 복원)
　G. `isSuspended`: 계약 정지 상태 여부 (포기 3회 누적 시 일시 정지)
　H. `suspendedUntil`: 정지 해제 예정일 (정지 상태인 경우)


**2.1.3.2.** 캠페인 참여 확정 API  

1: 엔드포인트  
　A. `POST /api/v1/partner/campaign/confirm`  
　B. 인증: Bearer Token (파트너 세션)  

2: 요청 Body  

```json
{
  "campaignId": "CMP-2026-0042",
  "confirmType": "DIRECT"
}
```

3: 등급별 분기 로직  

```js
// 등급별 확정 처리 분기
if (partnerGrade >= 'SILVER') {
  // 즉시 확정 처리
  confirmType = 'DIRECT';
  updateStatus('CONFIRMED');
} else if (partnerGrade === 'BRONZE') {
  // 결제 화면 이동
  confirmType = 'PAYMENT_REQUIRED';
  redirectToPayment(campaignId);
  // 결제 완료 콜백 시 확정 처리
}
```

4: 응답  
　A. 성공: `{ "status": "CONFIRMED", "confirmedAt": "..." }`  
　B. 브론즈 결제 필요: `{ "status": "PAYMENT_REQUIRED", "paymentUrl": "..." }`  


**2.1.3.3.** 캠페인 포기 API  

1: 엔드포인트  
　A. `POST /api/v1/partner/campaign/abandon`  
　B. 인증: Bearer Token (파트너 세션)  

2: 요청 Body  

```json
{
  "campaignId": "CMP-2026-0042",
  "abandonReason": "TEMPORARY_CLOSURE",
  "additionalInput": "2026-04-01"
}
```

3: 포기 사유 코드  
　A. `SIZE_CHANGE`: 컵홀더 규격 변경으로 호환 불가  
　B. `TEMPORARY_CLOSURE`: 임시 휴무/단축 운영(추가 입력: 재오픈 날짜)  
　C. `SEASONAL_EVENT`: 시즌/행사 운영(추가 입력: 재오픈 날짜)  
　D. `LOW_TRAFFIC`: 방문객 부족  
　E. `POLICY_MISMATCH`: 매장 운영 정책 불일치  
　F. `ETC`: 기타(추가 입력: 직접 입력 내용)  
　G. `TIMEOUT`: 응답 기한 초과 (시스템 자동 포기)  
　H. `MID_CAMPAIGN_TEXT`: 참여 중 포기 직접 입력 사유 (중도 포기 전용, 선택지 없이 텍스트만)  


**2.1.3.4.** 컴포넌트 상태 관리  

1: 상태 정의

```js
const matchingState = {
  status: 'IDLE',        // IDLE | MATCHED | CONFIRMED | ABANDONED | WAITING | WITHDRAW_REQUESTED | WITHDRAWN
  campaignData: null,    // 매칭된 캠페인 정보
  responseDeadline: null, // 응답 기한
  abandonCount: 0,       // 총 누적 포기 횟수
  abandonLimit: 3,       // 포기 허용 한도
  matchingPenalty: 0,    // 포기 누적 감점 (매칭 전/자동: -0.5, 참여 중: -1.0)
  isSuspended: false,    // 계약 정지 상태 (포기 3회 시)
  suspendedUntil: null,  // 정지 해제 예정일
  isLoading: false,
  error: null
};

const confirmDialogState = {
  isOpen: false,
  message: '',
  isProcessing: false
};

const abandonDialogState = {
  isOpen: false,
  selectedReasons: [],   // 선택된 사유
  additionalInputs: {},  // 사유별 추가 입력값
  isProcessing: false
};

const withdrawDialogState = {
  isOpen: false,
  confirmStep: false,    // 1차 확인 → 2차 사유 입력
  reasonText: '',        // 직접 입력 텍스트 (선택지 없음, 텍스트만)
  compensationInfo: null, // 남은 컵홀더 예상 보상 정보 { remaining, unitPrice, totalAmount }
  isProcessing: false
};

const withdrawRequestState = {
  requestId: null,       // 중도 포기 요청 ID
  status: 'NONE',       // NONE | PENDING | APPROVED | REJECTED
  requestedAt: null,     // 요청 일시
  reviewedAt: null,      // 관리자 처리 일시
  rejectionReason: null  // 반려 사유 (반려 시)
};
```


**2.1.3.5.** 리마인드 알림 및 자동 포기 로직  

1: 리마인드 알림 (필수 발송)  

```js
// 응답 기한 2시간 전 자동 발송 스케줄러
const scheduleReminder = (campaignId, responseDeadline) => {
  const reminderTime = new Date(responseDeadline);
  reminderTime.setHours(reminderTime.getHours() - 2);

  scheduleNotification({
    campaignId,
    type: 'MATCHING_REMINDER',
    scheduledAt: reminderTime,
    channels: ['PUSH', 'IN_APP'], // 필수 채널
    message: '캠페인 매칭 응답 기한이 2시간 남았습니다. 참여를 확정하시려면 지금 확인해 주세요. 미응답 시 자동 포기 처리됩니다.'
  });
};
```

2: 자동 포기 처리 (응답 기한 초과)

```js
// 응답 기한 만료 시 자동 포기 처리 스케줄러
const scheduleAutoAbandon = (campaignId, partnerId, responseDeadline) => {
  scheduleJob(responseDeadline, async () => {
    const matching = await getMatchingStatus(campaignId, partnerId);
    if (matching.status === 'MATCHED') { // 아직 미응답 상태
      await abandonCampaign({
        campaignId,
        partnerId,
        abandonCategory: 'TIMEOUT',
        abandonReason: 'TIMEOUT',
        isAutomatic: true
      });
      // 포기 횟수 즉시 1회 차감 + 매칭 감점 -0.5 (관리자 검토 없이 자동 처리)
      const abandonResult = await processAbandon(partnerId, campaignId, 'TIMEOUT', 'TIMEOUT');
      await sendNotification(partnerId, {
        type: 'AUTO_ABANDONED',
        message: `캠페인 매칭 응답 기한이 초과되어 자동으로 포기 처리되었습니다. 남은 포기 횟수: ${abandonResult.remaining}회`
      });
      // 파트너 사후 문의 시 관리자 검토 가능 (restoreAbandonCount 함수 사용)
    }
  });
};
```

3: 포기 횟수 관리

```js
// 총 누적 포기 횟수 조회 (기간 제한 없음, 복원된 건 제외)
const getAbandonCount = async (partnerId) => {
  return await db.query(
    'SELECT COUNT(*) FROM campaign_abandons WHERE partner_id = ? AND is_restored = false AND is_reset = false',
    [partnerId]
  );
};

// 포기 처리 (즉시 차감 + 유형별 차등 감점)
// abandonType: 'PRE_MATCH' | 'TIMEOUT' | 'MID_CAMPAIGN'
const processAbandon = async (partnerId, campaignId, reason, abandonType = 'PRE_MATCH') => {
  const ABANDON_LIMIT = 3;
  // 유형별 차등 감점
  const PENALTY_MAP = {
    'PRE_MATCH': -0.5,   // 매칭 전 포기
    'TIMEOUT': -0.5,     // 자동 포기 (미응답)
    'MID_CAMPAIGN': -1.0 // 참여 중 포기 (가중 감점)
  };
  const penalty = PENALTY_MAP[abandonType] || -0.5;

  // 포기 횟수 +1 차감
  await incrementAbandonCount(partnerId, campaignId, reason, abandonType);
  // 매칭 점수 감점 (유형별 차등)
  await adjustMatchingScore(partnerId, penalty);

  const count = await getAbandonCount(partnerId);
  const remaining = ABANDON_LIMIT - count;

  if (count >= ABANDON_LIMIT) {
    // 3회 도달: 계약 정지 (기존 이용제한 "일시 정지"와 동일)
    await suspendContract(partnerId, 'ABANDON_LIMIT_REACHED');
    await sendNotification(partnerId, {
      type: 'CONTRACT_SUSPENDED',
      message: '캠페인 포기가 3회에 도달하여 계약이 정지되었습니다. 상세 내용은 고객센터로 문의해 주세요.'
    });
    return { suspended: true, count, remaining: 0, penalty };
  }

  // 남은 포기 횟수 알림
  await sendNotification(partnerId, {
    type: 'ABANDON_PROCESSED',
    message: `캠페인 포기가 처리되었습니다. 남은 포기 횟수: ${remaining}회`
  });
  return { suspended: false, count, remaining, penalty };
};

// 관리자 사유 검토 후 포기 횟수 복원
const restoreAbandonCount = async (partnerId, abandonId) => {
  // 해당 포기 건의 유형 조회 (복원할 감점량 결정)
  const abandon = await db.query(
    'SELECT abandon_type, penalty_applied FROM campaign_abandons WHERE id = ?',
    [abandonId]
  );
  const restoreAmount = Math.abs(abandon.penalty_applied); // 적용됐던 감점만큼 복원

  await db.query(
    'UPDATE campaign_abandons SET is_restored = true, admin_review = "LEGITIMATE", reviewed_at = NOW() WHERE id = ?',
    [abandonId]
  );
  // 매칭 감점 복원 (유형별: 매칭 전/자동 +0.5, 참여 중 +1.0)
  await adjustMatchingScore(partnerId, restoreAmount);
  await sendNotification(partnerId, {
    type: 'ABANDON_RESTORED',
    message: '관리자 검토 결과, 포기 사유가 인정되어 포기 횟수가 복원되었습니다.'
  });
};

// 계약 정지 해제 시 포기 횟수 + 감점 초기화
const releaseContractSuspension = async (partnerId) => {
  // 포기 횟수 초기화 (이력은 보존, is_reset 플래그로 관리)
  await db.query(
    'UPDATE campaign_abandons SET is_reset = true WHERE partner_id = ? AND is_reset = false',
    [partnerId]
  );
  // 매칭 감점 초기화
  await resetMatchingPenalty(partnerId);
  // 정지 해제
  await updateContractStatus(partnerId, 'ACTIVE');
  // 정지 사유 이력 기록
  await recordSuspensionHistory(partnerId, 'RELEASED');
};
```


**2.1.3.6.** 캠페인 참여 중지 API (중도 포기 — 관리자 승인 필요)  

1: 파트너 요청 API  
　A. `POST /api/v1/partner/campaign/withdraw/request`  
　B. 인증: Bearer Token (파트너 세션)  

2: 요청 Body  

```json
{
  "campaignId": "CMP-2026-0042",
  "withdrawReason": "매장 리뉴얼로 인한 운영 중단"
}
```

　A. `withdrawReason`: 직접 입력 텍스트 (선택지 없음, 필수)

3: 요청 응답  

```json
{
  "requestId": "WR-2026-0088",
  "status": "WITHDRAW_REQUESTED",
  "requestedAt": "2026-03-15T10:30:00+09:00",
  "estimatedCompensation": {
    "remainingCupholders": 150,
    "unitPrice": 120,
    "totalAmount": 18000
  }
}
```

　A. 요청 접수 시 예상 보상금 정보 포함 (확정 금액은 승인 시점에 재계산)
　B. 실패: `{ "error": "CMP_004", "message": "참여 중지 요청에 실패했습니다." }`
　C. 이미 요청 중: `{ "error": "CMP_006", "message": "이미 참여 중지 요청이 진행 중입니다." }`

4: 관리자 승인/반려 API  
　A. `POST /api/v1/admin/campaign/withdraw/review`  
　B. 인증: Bearer Token (관리자 세션)  

5: 관리자 요청 Body  

```json
{
  "requestId": "WR-2026-0088",
  "decision": "APPROVED",
  "isLegitimate": false,
  "adminNote": "검토 완료"
}
```

　A. `decision`: `APPROVED` | `REJECTED`
　B. `isLegitimate`: 합당한 사유 여부 (true일 경우 포기 횟수 미차감)
　C. `adminNote`: 관리자 메모 (반려 시 반려 사유로 파트너에게 전달)

6: 요청 처리 로직

```js
// 파트너: 중도 포기 요청 제출
const handleWithdrawRequest = async (partnerId, campaignId, reasonText) => {
  // 이미 요청 중인지 확인
  const existing = await getWithdrawRequest(partnerId, campaignId);
  if (existing && existing.status === 'PENDING') {
    throw new Error('CMP_006: 이미 참여 중지 요청이 진행 중입니다.');
  }

  // 요청 생성 (캠페인 상태는 WITHDRAW_REQUESTED로 변경, 캠페인 계속 참여)
  const request = await createWithdrawRequest(partnerId, campaignId, reasonText);
  await updateCampaignStatus(campaignId, partnerId, 'WITHDRAW_REQUESTED');

  // 예상 보상금 계산 (확정 아님)
  const estimatedCompensation = await estimateCompensation(partnerId, campaignId);

  // 요청 접수 알림
  await sendNotification(partnerId, {
    type: 'WITHDRAW_REQUESTED',
    message: '참여 중지 요청이 접수되었습니다. 관리자 검토 후 결과가 안내됩니다. 승인 전까지 캠페인 참여를 유지해 주세요.'
  });

  // 관리자에게 검토 요청 알림
  await sendAdminNotification({
    type: 'WITHDRAW_REVIEW_NEEDED',
    partnerId, campaignId,
    requestId: request.id,
    reason: reasonText
  });

  return { requestId: request.id, status: 'WITHDRAW_REQUESTED', estimatedCompensation };
};

// 관리자: 중도 포기 요청 승인
const approveWithdrawRequest = async (requestId, isLegitimate, adminNote) => {
  const request = await getWithdrawRequestById(requestId);
  const { partnerId, campaignId } = request;

  // 참여 기간 산정
  const participationDays = calculateParticipationDays(partnerId, campaignId);

  // 캠페인 상태 확정
  await updateCampaignStatus(campaignId, partnerId, 'WITHDRAWN');

  // 승인 시점부터 미매칭 기간 카운트 시작
  await setUnmatchedStartDate(partnerId, new Date());

  // 남은 컵홀더 보상금 계산 및 즉시 정산
  const compensation = await calculateAndSettleCompensation(partnerId, campaignId);

  // 포기 횟수 + 감점 처리 (합당 사유 시 미차감 처리 가능)
  let abandonResult = null;
  if (isLegitimate) {
    // 합당한 사유: 포기 횟수 미차감, 감점 없음
    await recordWithdrawAsLegitimate(requestId);
    abandonResult = { count: await getAbandonCount(partnerId), remaining: 3 - await getAbandonCount(partnerId), suspended: false, penalty: 0 };
  } else {
    // 포기 횟수 +1 차감 + 매칭 점수 -1.0 감점
    abandonResult = await processAbandon(partnerId, campaignId, request.reason, 'MID_CAMPAIGN');
  }

  // 승인 완료 알림
  await sendNotification(partnerId, {
    type: 'WITHDRAW_APPROVED',
    message: `캠페인 참여 중지가 승인되었습니다. 남은 포기 횟수: ${abandonResult.remaining}회. 보상금 ₩${compensation.totalAmount}이 정산됩니다.`
  });

  // 요청 상태 업데이트
  await updateWithdrawRequest(requestId, 'APPROVED', adminNote);

  return { participationDays, compensation, abandonResult };
};

// 관리자: 중도 포기 요청 반려
const rejectWithdrawRequest = async (requestId, adminNote) => {
  const request = await getWithdrawRequestById(requestId);
  const { partnerId, campaignId } = request;

  // 캠페인 상태 복원
  await updateCampaignStatus(campaignId, partnerId, 'CONFIRMED');

  // 반려 알림
  await sendNotification(partnerId, {
    type: 'WITHDRAW_REJECTED',
    message: `참여 중지 요청이 반려되었습니다. 사유: ${adminNote}. 캠페인 참여를 계속해 주세요.`
  });

  // 요청 상태 업데이트
  await updateWithdrawRequest(requestId, 'REJECTED', adminNote);
};

// 남은 컵홀더 보상금 계산 및 정산
const calculateAndSettleCompensation = async (partnerId, campaignId) => {
  const delivered = await getDeliveredQuantity(campaignId, partnerId);
  const consumed = await getReportedConsumption(campaignId, partnerId);
  const remaining = delivered - consumed;

  if (remaining <= 0) {
    return { remainingCupholders: 0, unitPrice: 0, totalAmount: 0, settledAt: new Date() };
  }

  const unitPrice = await getPartnerStandardPrice();
  const totalAmount = remaining * unitPrice;

  await settleCompensation(partnerId, campaignId, {
    remainingCupholders: remaining,
    unitPrice,
    totalAmount,
    direction: 'PARTNER_TO_WITHFOM',
    settledAt: new Date()
  });

  return { remainingCupholders: remaining, unitPrice, totalAmount, settledAt: new Date() };
};
```


**2.1.3.7.** 접근성 요구사항  

1: 다이얼로그 접근성  
　A. 확인/포기/참여 중지 팝업: `role="dialog"`, `aria-modal="true"`, `aria-labelledby` 지정  
　B. 팝업 열림 시 포커스 트랩 적용, 닫힘 시 트리거 버튼으로 포커스 복귀  
　C. ESC 키로 팝업 닫기 지원  

2: 체크박스 접근성  
　A. 포기 사유 체크박스: `role="checkbox"`, `aria-checked` 상태 관리  
　B. 조건부 입력창: `aria-expanded` 연동, 선택 시 입력창으로 포커스 이동  

3: 상태 뱃지 접근성
　A. "참여중" 뱃지: `aria-label="캠페인 참여 중"` 지정
　B. "참여 중지 요청중" 뱃지: `aria-label="캠페인 참여 중지 요청 중"` 지정
　C. "참여 필수" 라벨: `aria-label="캠페인 참여 필수"` 지정
　D. 포기 횟수 표시: `aria-live="polite"` 적용 (횟수 변경 시 스크린 리더 안내)


**2.1.3.8.** 에러 처리  

1: 에러 코드  
　A. `CMP_001`: 매칭 정보 조회 실패 → "캠페인 매칭 정보를 불러올 수 없습니다. 잠시 후 다시 시도해 주세요." 토스트 표시  
　B. `CMP_002`: 참여 확정 실패 → "캠페인 참여 확정에 실패했습니다. 잠시 후 다시 시도해 주세요." 토스트 표시, 재시도 버튼 제공  
　C. `CMP_003`: 포기 처리 실패 → "캠페인 포기 처리에 실패했습니다. 잠시 후 다시 시도해 주세요." 토스트 표시, 재시도 버튼 제공  
　D. `CMP_004`: 참여 중지 요청 실패 → "캠페인 참여 중지 요청에 실패했습니다. 잠시 후 다시 시도해 주세요." 토스트 표시, 재시도 버튼 제공  
　E. `CMP_005`: 계약 정지 상태 → "캠페인 포기 3회 누적으로 계약이 정지되었습니다. 상세 내용은 고객센터로 문의해 주세요." 안내 표시  
　F. `CMP_006`: 중복 요청 → "이미 참여 중지 요청이 진행 중입니다." 토스트 표시  
