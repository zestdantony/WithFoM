<!-- WF:DOC=DEV -->
**2.6.** 개발자 인터랙션 명세  


**2.6.1.** API 명세  


**2.6.1.1.** 코인 현황 조회  

1: 엔드포인트  
　A. `GET /api/v1/partner/coins`  
　B. 인증: Bearer Token(파트너 세션)  

2: 응답 JSON  

```json
{
  "totalCoins": 1500,
  "allocatedCoins": 500,
  "availableCoins": 1000,
  "monthlyBonus": 200,
  "plan": "PLUS",
  "expiringCoins": {
    "within7Days": 100,
    "within30Days": 250,
    "allocatedExpiring30Days": 50
  },
  "maxHolding": 100000
}
```

3: 응답 필드  
　A. `totalCoins`: 총 보유 폼 코인 수량  
　B. `allocatedCoins`: 게임에 적립된 코인 (고객 무료 게임 제공용)  
　C. `availableCoins`: 사용 가능 코인 (= totalCoins − allocatedCoins)  
　D. `monthlyBonus`: 이번 달 멤버십 증정 코인 (베이직: 0, 플러스: 200, 프리미엄: 500)  
　E. `expiringCoins.within7Days`: 7일 내 만료 예정 코인  
　F. `expiringCoins.within30Days`: 30일 내 만료 예정 코인  
　G. `expiringCoins.allocatedExpiring30Days`: 게임 적립 코인 중 30일 내 만료 예정 수량  
　H. `maxHolding`: 매장당 최대 보유 한도 (100,000개)  

4: 에러  
　A. 401: 미인증  
　B. CN_001: 코인 현황 조회 실패  


**2.6.1.2.** 코인 구매  

1: 엔드포인트  
　A. `POST /api/v1/partner/coins/purchase`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| quantity | number | Y | 구매 수량(1,000 단위, 최소 1,000) |
| paymentMethodId | string | Y | 결제 수단 ID (카드 또는 계좌이체) |
| idempotencyKey | string | Y | 이중 결제 방지 키 (UUID v4) |

3: 코인 단가·결제 금액  
　A. 폼 코인 1개 = 10원  
　B. 결제 금액 = quantity × 10원  

4: 응답  
　A. 성공: `{ "success": true, "newBalance": 2500, "transactionId": "tx_001", "receiptUrl": "/receipts/tx_001", "receiptType": "TAX_INVOICE" }`  
　B. `receiptType`: TAX_INVOICE(사업자 전자세금계산서) | CASH_RECEIPT(현금영수증) | CARD_SLIP(카드 매출전표)  
　C. 400: 수량 단위 오류(1,000 단위 아님)  
　D. 409: 최대 보유 한도(100,000개) 초과 또는 idempotency key 중복  

5: 에러  
　A. CN_002: 구매 실패  
　B. CN_003: PG 결제 실패  


**2.6.1.3.** 코인 환불  

1: 엔드포인트  
　A. `POST /api/v1/partner/coins/refund`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| transactionId | string | Y | 원 구매 거래 ID |

3: 응답  
　A. 성공: `{ "refunded": true, "refundedQuantity": 1000, "newBalance": 1500, "estimatedRefundDate": "2026-01-22" }`  
　B. `estimatedRefundDate`: 환불 예상 완료일 (영업일 3~5일 기준 계산)  
　C. 400: 환불 불가(7일 초과 또는 사용 이력 존재)  
　D. 400: 적립 중인 코인 포함 시 → `{ "error": "ALLOCATED_COINS_EXIST", "message": "게임 적립 해제 후 환불 가능합니다" }`  

4: 에러  
　A. CN_004: 환불 처리 실패  


**2.6.1.4.** 코인 내역 조회  

1: 엔드포인트  
　A. `GET /api/v1/partner/coins/history`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 쿼리 파라미터  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| type | string | N | purchase \| bonus \| allocate \| consume \| expire \| refund. 기본값: all |
| startDate | string | N | YYYY-MM-DD |
| endDate | string | N | YYYY-MM-DD |
| page | number | N | 페이지 번호. 기본값: 1 |
| limit | number | N | 페이지 당 건수. 기본값: 20 |

3: 응답 JSON  

```json
{
  "items": [
    {
      "date": "2026-01-15T14:30:00",
      "type": "purchase",
      "quantity": 1000,
      "balance": 2500,
      "description": "코인 구매",
      "transactionId": "tx_001",
      "refundable": true,
      "receiptUrl": "/receipts/tx_001"
    }
  ],
  "monthlySummary": {
    "purchased": 2000,
    "bonus": 200,
    "consumed": 150,
    "expired": 0
  },
  "pagination": { "page": 1, "totalPages": 3, "totalItems": 45 }
}
```

4: 응답 필드 (추가)  
　A. `items[].refundable`: 해당 구매 건 환불 가능 여부 (구매 건만 해당, 7일 이내 + 미사용)  
　B. `items[].receiptUrl`: 결제 증빙 URL (구매 건만 해당)  

5: 에러  
　A. CN_005: 내역 조회 실패  


**2.6.1.5.** 게임 코인 적립  

1: 엔드포인트  
　A. `POST /api/v1/partner/coins/allocate`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| amount | number | Y | 적립할 코인 수량 |

3: 응답  
　A. 성공: `{ "allocated": true, "newAllocated": 500, "newAvailable": 1000 }`  
　B. 400: 보유 코인 부족  

4: 에러  
　A. CN_006: 코인 적립 실패  


**2.6.1.6.** 게임 코인 적립 해제  

1: 엔드포인트  
　A. `POST /api/v1/partner/coins/deallocate`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| amount | number | Y | 적립 해제할 코인 수량 |

3: 응답  
　A. 성공: `{ "deallocated": true, "newAllocated": 200, "newAvailable": 1300 }`  
　B. 400: 적립 잔량 부족 → `{ "error": "INSUFFICIENT_ALLOCATED", "currentAllocated": 200 }`  

4: 유의사항  
　A. 적립 해제된 코인은 사용 가능 상태로 복원  
　B. 적립 해제 후 무료 게임 제공 가능 횟수 즉시 감소  
　C. 적립 잔량 0 시 무료 게임 자동 중단  

5: 에러  
　A. CN_008: 적립 해제 실패  


**2.6.1.7.** 무료 게임 제공 설정 조회  

1: 엔드포인트  
　A. `GET /api/v1/partner/coins/free-play-settings`  
　B. 인증: Bearer Token(파트너 세션)  

2: 응답 JSON  

```json
{
  "dailyLimit": 100,
  "targetCustomers": ["regular", "vip"],
  "vipCondition": { "visitCount": 10, "paymentAmount": 100000 },
  "timeRange": {
    "type": "CUSTOM",
    "start": "14:00",
    "end": "18:00"
  },
  "autoRecharge": {
    "enabled": true,
    "threshold": 100,
    "quantity": 1000,
    "paymentMethodId": "pm_001",
    "monthlyUsed": 2,
    "monthlyLimit": 10,
    "status": "ACTIVE",
    "cardExpiryDate": "2027-03",
    "cardExpiryWarning": false
  },
  "allocatedCoins": 500,
  "remainingFreeGames": 500,
  "todayConsumed": 23
}
```

3: 응답 필드  
　A. `timeRange.type`: ALL_DAY(24시간) | CUSTOM(특정 시간대) | BUSINESS_HOURS(영업 시간 연동)  
　B. `autoRecharge.monthlyUsed`: 이번 달 자동 충전 사용 횟수  
　C. `autoRecharge.monthlyLimit`: 월 최대 자동 충전 횟수 (고정 10회)  
　D. `autoRecharge.status`: ACTIVE | PAUSED(3차 실패 중지) | CARD_EXPIRED  
　E. `autoRecharge.cardExpiryDate`: 등록 카드 유효기간(YYYY-MM)  
　F. `autoRecharge.cardExpiryWarning`: 카드 만료 30일 이내 시 true  
　G. `remainingFreeGames`: 남은 무료 게임 제공 가능 횟수 (= allocatedCoins)  
　H. `todayConsumed`: 오늘 소모된 코인 수량  

4: 에러  
　A. CN_009: 설정 조회 실패  


**2.6.1.8.** 무료 게임 제공 설정 저장  

1: 엔드포인트  
　A. `PUT /api/v1/partner/coins/free-play-settings`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| dailyLimit | number | Y | 하루 최대 제공 횟수 |
| targetCustomers | array | Y | ["all" \| "new" \| "regular" \| "vip" \| "dormant"] |
| vipCondition | object | N | { "visitCount": N, "paymentAmount": N } |
| timeRange | object | N | { "type": "ALL_DAY \| CUSTOM \| BUSINESS_HOURS", "start": "HH:mm", "end": "HH:mm" } |
| autoRecharge | object | N | { "enabled": boolean, "threshold": N, "quantity": N, "paymentMethodId": "string" } |

3: 요청 필드 상세  
　A. `timeRange.type`: ALL_DAY → start/end 무시, CUSTOM → start/end 필수, BUSINESS_HOURS → 매장 설정(7-2-6-3) 영업 시간 자동 연동(start/end 무시)  
　B. `autoRecharge.quantity`: 1,000 단위 필수  
　C. `autoRecharge.enabled`: false 시 threshold/quantity/paymentMethodId 무시  
　D. `targetCustomers` 검증: "all" 포함 시 다른 값과 동시 선택 불가 → `{ "error": "ALL_EXCLUSIVE_TARGET" }`  
　E. 고객 1인당 하루 무료 게임 한도: 1회 (서버 고정, 변경 불가) — 초과 시 고객 본인 코인 사용  

4: 응답  
　A. 성공: `{ "saved": true, "updatedAt": "2026-01-15T14:30:00" }`  

5: 에러  
　A. CN_007: 설정 저장 실패  


**2.6.2.** 컴포넌트 구현 참고  


**2.6.2.1.** 코인 구매 모달 이중 결제 방지  

1: 모달 오픈 시 UUID v4로 idempotencyKey 생성  
2: [결제하기] 클릭 → 즉시 disabled + 스피너 → API 호출  
3: 응답 수신 후 결과 표시, 모달 닫기 전 현황 API 재호출하여 잔액 갱신  


**2.6.2.2.** PG 웹훅 비동기 복구  

1: 복구 대상 조건  
　A. PG 결제 성공(PG사 승인 완료) + 서버 코인 적립 API 실패(네트워크·타임아웃 등)  

2: 처리 흐름  

```
PG 결제 승인 → 서버 코인 반영 시도
  ├─ 성공 → 정상 완료
  └─ 실패 → 클라이언트 안내: "결제는 완료되었으나 코인 반영에 실패했습니다. 자동 복구를 시도합니다."
             └─ PG 웹훅 수신 대기
                 ├─ 웹훅 수신 → 코인 반영 재시도 (최대 3회)
                 │   ├─ 성공 → 코인 반영 + 파트너 알림: "코인 N개가 정상 반영되었습니다"
                 │   └─ 3회 실패 → 5분 타임아웃 처리로 이관
                 └─ 5분 내 미수신 → 고객센터 자동 알림 + 파트너 안내: "코인 반영이 지연되고 있습니다. 고객센터에서 확인 중입니다."
```

3: 중복 반영 방지  
　A. transactionId 기반 멱등성 보장 — 동일 거래 재처리 시 중복 적립 차단  


**2.6.2.3.** 자동 충전 로직  

1: 서버 측 스케줄러에서 게임 코인 잔량 감시  
2: threshold 이하 → paymentMethodId로 자동 구매 API 호출  
3: 실패 시 안전장치 로직 적용  
　A. 1차 실패: 1시간 후 재시도  
　B. 2차 실패: 24시간 후 재시도 + 파트너 알림(푸시+이메일)  
　C. 3차 실패: 자동 충전 일시 중지(status → PAUSED) + "결제 수단을 확인하세요" 경고 배너  
　D. 중지 후 파트너가 결제 수단 변경 또는 수동 충전 시 자동 충전 재활성화(status → ACTIVE)  

4: 월 자동 충전 한도  
　A. 월 최대 자동 충전 횟수: 10회  
　B. 10회 도달 시 자동 충전 일시 중지(status → PAUSED) + 파트너 알림: "이번 달 자동 충전 한도(10회)에 도달했습니다"  
　C. 매월 1일 00:00 monthlyUsed 초기화 + 한도 중지 해제  

5: 카드 만료 예정 알림  
　A. 등록 카드 유효기간(cardExpiryDate) 30일 전: cardExpiryWarning → true  
　B. 파트너 알림: "자동 충전 카드가 곧 만료됩니다. 결제 수단을 확인해 주세요"  
　C. 카드 만료 시: 자동 충전 중지(status → CARD_EXPIRED) + 결제 수단 변경 안내  


**2.6.2.4.** 적립 코인 만료 처리  

1: 만료 감시 대상  
　A. 게임에 적립된 코인도 구매 시점 유효기간(1년) 적용  
　B. 적립 = 사용 예약 상태이므로 만료 대상에서 제외하지 않음  

2: 만료 경고  
　A. 적립 코인 중 30일 내 만료 예정 존재 시: allocatedExpiring30Days > 0  
　B. 파트너 알림(30일 전): "게임에 적립된 코인 N개가 30일 내 만료됩니다"  
　C. 적립 코인 중 7일 내 만료 예정 존재 시: expiringCoins.within7Days > 0 + 적립 코인 포함 여부 추가 확인  
　D. 파트너 알림(7일 전): "⚠️ 게임에 적립된 코인 N개가 7일 내 만료됩니다. 사용을 서둘러 주세요."  

3: 만료 시 처리 흐름  

```
서버 일간 배치 → 만료 코인 식별
  └─ 적립 코인 만료 처리
      ├─ allocatedCoins -= 만료 수량
      ├─ 코인 내역에 expire 타입 기록
      ├─ 잔량 > 0 → 파트너 알림: "적립 코인 N개가 만료되었습니다 (남은 적립: M개)"
      └─ 잔량 = 0 → 무료 게임 자동 중단 + 파트너 알림: "적립 코인이 모두 만료되어 무료 게임이 중단되었습니다. 코인을 재적립해 주세요."
```

4: 재적립 시  
　A. 새로 구매한 코인(유효기간 1년)으로 재적립  
　B. 무료 게임 자동 재개  


**2.6.2.5.** 멤버십 다운그레이드 코인 처리  

1: 보유 코인 처리  
　A. 보유 코인은 멤버십 변경과 무관하게 유지  
　B. 유효기간 내 정상 사용 가능  

2: 월 증정 코인 변경  
　A. 변경된 플랜 기준 익월부터 적용  
　B. 프리미엄 → 플러스: 500개 → 200개  
　C. 플러스 → 베이직: 200개 → 0개 (증정 중단)  
　D. 기존 잔여 증정 코인은 유효기간까지 사용 가능 (회수 없음)  

3: 서버 처리  

```
멤버십 변경 이벤트 수신
  └─ monthlyBonus 값 갱신 (plan 기준 재계산)
      └─ 다음 증정일(매월 1일)부터 새 플랜 기준 적용
```


**2.6.2.6.** 무료 게임 적립·대상·시간 통합 저장  

1: 코인 적립(2.6.1.5.)과 설정 저장(2.6.1.8.)은 별도 API  
2: 적립은 즉시 반영, 설정은 [저장] 버튼 클릭 시 반영  
3: 화면 구성: 코인 현황(2.1.) → 코인 내역(2.3.) → 무료 게임 제공(2.4.) 순서로 스크롤  
4: 페이지 로드 시 2.6.1.1.(현황) + 2.6.1.7.(설정) 병렬 호출  
5: 고객 무료 게임 소비 시 코인 차감  
　A. 소비자가 무료 게임 이용 시 → 서버에서 allocatedCoins 1개 차감  
　B. 무료 게임 1회 = 코인 1개 소모 (유료 전환: 소비자 본인 코인 1개 사용)  
　C. 유료 전환 흐름: 9-3-12 > 3. 게임 이용 방법 참조  


**2.6.3.** 에러 코드 종합  


**2.6.3.1.** 에러 코드  

1: CN_001: 코인 현황 조회 실패  
2: CN_002: 코인 구매 실패  
3: CN_003: PG 결제 실패  
4: CN_004: 환불 처리 실패  
5: CN_005: 내역 조회 실패  
6: CN_006: 코인 적립 실패  
7: CN_007: 무료 게임 설정 저장 실패  
8: CN_008: 코인 적립 해제 실패  
9: CN_009: 무료 게임 설정 조회 실패  
10: CN_010: 자동 충전 실패  
11: CN_011: 적립 코인 만료 처리 실패  
12: CN_012: 대상 고객 "모든 고객" 배타 선택 위반  

**2.6.3.2.** 공통  

1: 인증 실패: 401, 로그인 페이지로 유도  
2: 5xx: "일시적인 오류가 발생했습니다" + 재시도 안내  


• 참조: 2.0.~2.5. 코인 관리 전 섹션, 3-7-1 > 5. 코인 시스템, 7-2-6-3. 매장 관리(영업 시간)  
