<!-- WF:DOC=DEV -->
**2.9.** 개발자 인터랙션 명세  


**2.9.1.** API 명세  


**2.9.1.1.** 코인 현황 조회  

1: 엔드포인트  
　A. `GET /api/v1/partner/coins`  
　B. 인증: Bearer Token(파트너 세션)  

2: 응답 JSON  

```json
{
  "totalCoins": 0,
  "allocatedCoins": 0,
  "availableCoins": 0,
  "monthlyBonus": 0,
  "plan": "BASIC | PLUS | PREMIUM",
  "expiringCoins": { "within7Days": 0, "within30Days": 0 },
  "maxHolding": 100000
}
```

3: 에러  
　A. 401: 미인증  
　B. CN_001: 코인 현황 조회 실패  


**2.9.1.2.** 코인 구매  

1: 엔드포인트  
　A. `POST /api/v1/partner/coins/purchase`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| quantity | number | Y | 구매 수량(1,000 단위) |
| paymentMethodId | string | Y | 결제 수단 ID |
| idempotencyKey | string | Y | 이중 결제 방지 키 |

3: 응답  
　A. 성공: `{ "success": true, "newBalance": 0, "transactionId": "string", "receiptUrl": "string" }`  
　B. 400: 수량 단위 오류  
　C. 409: 최대 보유 한도 초과 또는 idempotency key 중복  

4: 에러  
　A. CN_002: 구매 실패  
　B. CN_003: PG 결제 실패  


**2.9.1.3.** 코인 환불  

1: 엔드포인트  
　A. `POST /api/v1/partner/coins/refund`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| transactionId | string | Y | 원 구매 거래 ID |

3: 응답  
　A. 성공: `{ "refunded": true, "refundedQuantity": 0, "newBalance": 0 }`  
　B. 400: 환불 불가(7일 초과 또는 사용 이력 존재)  

4: 에러  
　A. CN_004: 환불 처리 실패  


**2.9.1.4.** 코인 내역 조회  

1: 엔드포인트  
　A. `GET /api/v1/partner/coins/history`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 쿼리 파라미터  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| type | string | N | purchase \| bonus \| allocate \| consume \| expire \| refund. 기본값: all |
| startDate | string | N | YYYY-MM-DD |
| endDate | string | N | YYYY-MM-DD |
| page | number | N | 페이지 번호. 기본값: 1 |
| limit | number | N | 페이지 당 건수. 기본값: 20 |

3: 응답 JSON  

```json
{
  "items": [
    {
      "date": "YYYY-MM-DDTHH:mm:ss",
      "type": "purchase | bonus | allocate | consume | expire | refund",
      "quantity": 0,
      "balance": 0,
      "description": "string",
      "transactionId": "string | null"
    }
  ],
  "monthlySummary": {
    "purchased": 0,
    "bonus": 0,
    "consumed": 0,
    "expired": 0
  },
  "pagination": { "page": 1, "totalPages": 1, "totalItems": 0 }
}
```

4: 에러  
　A. CN_005: 내역 조회 실패  


**2.9.1.5.** 게임 코인 적립  

1: 엔드포인트  
　A. `POST /api/v1/partner/coins/allocate`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| amount | number | Y | 적립할 코인 수량 |

3: 응답  
　A. 성공: `{ "allocated": true, "newAllocated": 0, "newAvailable": 0 }`  
　B. 400: 보유 코인 부족  

4: 에러  
　A. CN_006: 코인 적립 실패  


**2.9.1.6.** 무료 게임 제공 설정 저장  

1: 엔드포인트  
　A. `PUT /api/v1/partner/coins/free-play-settings`  
　B. 인증: Bearer Token(파트너 세션)  

2: 요청 바디  

| 파라미터 | 타입 | 필수 | 설명 |
|----------|------|------|------|
| dailyLimit | number | Y | 하루 최대 제공 횟수 |
| targetCustomers | array | Y | ["all" \| "new" \| "regular" \| "vip" \| "dormant"] |
| vipCondition | object | N | { "visitCount": N, "paymentAmount": N } |
| timeRange | object | N | { "start": "HH:mm", "end": "HH:mm" } (null = 24시간) |
| autoRecharge | object | N | { "enabled": boolean, "threshold": N, "quantity": N, "paymentMethodId": "string" } |

3: 응답  
　A. 성공: `{ "saved": true, "updatedAt": "YYYY-MM-DDTHH:mm:ss" }`  

4: 에러  
　A. CN_007: 설정 저장 실패  


**2.9.2.** 컴포넌트 구현 참고  


**2.9.2.1.** 코인 구매 모달 이중 결제 방지  

1: 모달 오픈 시 UUID v4로 idempotencyKey 생성  
2: [결제하기] 클릭 → 즉시 disabled + 스피너 → API 호출  
3: 응답 수신 후 결과 표시, 모달 닫기 전 현황 API 재호출하여 잔액 갱신  


**2.9.2.2.** 자동 충전 로직  

1: 서버 측 스케줄러에서 게임 코인 잔량 감시  
2: threshold 이하 → paymentMethodId로 자동 구매 API 호출  
3: 실패 시 2.4.3.3. 안전장치 로직 적용(1차 1시간 → 2차 24시간 → 3차 중지)  


**2.9.2.3.** 무료 게임 적립·대상·시간 통합 저장  

1: 코인 적립(2.9.1.5.)과 설정 저장(2.9.1.6.)은 별도 API  
2: 적립은 즉시 반영, 설정은 [저장] 버튼 클릭 시 반영  
3: 화면 구성: 코인 현황(2.1.) → 코인 내역(2.3.) → 무료 게임 제공(2.4.) 순서로 스크롤  


• 참조: 2.0.~2.4., 2.8., 3-7-1 > 5. 코인 시스템  
